# Ask! v0.4 Report

## Source code and documentation

- [ask][ask-url]: Source code of Ask! v0.4

- [ask-template][ask-template-url]: A template for creating an Ask! v0.4 contract project.

- [ask-docs][ask-doc-url]: Documentation of Ask! v0.4

- [as-serde][as-serde-url]: A simple (de)serialization framework for AssemblyScript

- [as-serde-scale][as-serde-scale-url]: SCALE (de)serialization library based on as-serde framework.

- [as-serde-json][as-serde-json-url]: JSON (de)serialization library based on as-serde framework.

[ask-url]: https://github.com/ask-lang/ask
[ask-template-url]: https://github.com/ask-lang/ask-template
[ask-doc-url]: https://ask-lang.github.io/ask-docs/
[as-serde-url]: https://github.com/ask-lang/serde-as
[as-serde-scale-url]: https://github.com/ask-lang/serde-as/blob/main/packages/as-serde-scale/README.md
[as-serde-json-url]: https://github.com/ask-lang/serde-as/blob/main/packages/as-serde-json/README.md
[as-scale-codec-url]: https://github.com/LimeChain/as-scale-codec
[pallet-contracts-url]: https://github.com/paritytech/substrate/tree/master/frame/contracts

## New design and implementation

In Ask! v0.4, we use a new architecture to design contract compilation and generation. And based on the new architecture, we redesigned the contract syntax that closer to ink! v3. In addition we also use a new and higher performance scale codec library constructed by ourselves.

### Architecture

Compiling a wasm smart contract with Ask! v0.3 actually goes through **TWO** compilation processes.

In the first compilation process, Ask! v0.3 only checks the contract syntax, and then checks the specific type and semantics for the second time. The final assemblyscript code is generated by splicing strings, which also results in very poor readability of the generated code, and error messages are difficult to locate the problem. Even some obviously wrong contract code can pass the compilation check and generate wasm.

Although Ask! v0.3 introduced ask-cli, which is similar to the cargo-contract role in ink, to partially solve the two compilation problem, in the process of using it, we found that the `original architecture + ask-cli` is not elegant, and ask-cli itself requires additional learning costs for contract developers.

After some investigation and simple verification, we use a simpler architecture to compile and generate the wasm contract code: manipulate the AST generated by the contract code through the assemblyscript toolchain to get final wasm code and metadata, without introducing additional tools (like `ask-cli` or `cargo-contract`) to help development of wasm contracts.

In this way, the generated assemblyscript code has better readability, and the type checking and error messages have been greatly improved. And the contract development will only involve the assemblyscript toolchain and  Ask! contract syntax.

|               | Ask! v0.3  | Ask! v0.4 |
|---------------|------------|-----------|
| Components    | <ul><li>Contract Framework</li><li>Contract Preprocessor</li><li>ask-cli</li></ul> | <ul><li>Contract Framework</li><li>Transform Framework</li></ul> |
| Learning Cost | <ul><li>assemblyscript toolchain</li><li>Ask contract syntax</li><li>ask-cli tool</li></ul> | <ul><li>assemblyscript toolchain</li><li>Ask contract syntax</li></ul>
| Codec Library |  forked version of [as-scale-codec][as-scale-codec-url] | our new implmentation: [as-serde-scale][as-serde-scale-url] |

For more detailed usage, please refer to our [template][ask-template-url] and [documentation][ask-doc-url] .

### Implementaion && Optimization

- **Compilation && Generate**: As mentioned above, now developers only need to use a package manager (`npm` or `yarn`) to import `assemblyscript` and `ask-transform` packages to develop Ask! contracts, and directly compile and generate wasm code and metadata through the assemblyscript toolchain. See [template][ask-template-url] for details.

- **Contract framework**: We have rewritten the contract syntax framework based on the new architecture. The current Ask! contract syntax still uses the decorator syntax, but it's closer to the procedural macro style of ink! v3.
  
- **Codec**: Ask! v0.3 uses a forked version of [as-scale-codec][as-scale-codec-url] (the upstream doesn't seem to be maintained anymore, last commit was a year ago) for SCALE encoding/decoding, but in Ask! v0.4, we create a new library [as-serde-scale][as-serde-scale-url], compared with [as-scale-codec][as-scale-codec-url], [as-serde-scale][as-serde-scale-url] has better codec performance, more complete implementation, easy to use, and it's maintained by ourselves.

### Compatibility

We have synchronized the latest host functions of [pallet-contracts][pallet-contracts-url], and the current syntax of Ask! v0.4 is also very close to ink! v3 style, developers can easily migrate contract code between ink! and Ask!. And the `metadata.json` generated by Ask! v0.4 is also compatible with the `metadata.json` generated by ink!.

## Future works

- Upgrade [assemblyscript][assemblyscript-url] toolchain to the latest
  The current Ask! v0.4 is based on assemblyscript v0.19, and now the latest assemblyscript version is v0.22.
  Originally, we planned to use the latest version in Ask! v0.4, but some dependencies ([as-pect][as-pect-url]/[visitor-as][visitor-as-url]) of Ask! has not been upgraded to the latest assemblyscript. So in future versions we will consider upgrading to the latest assemblyscript toolchain, and even need to help maintain these dependencies.

[assemblyscript-url]: https://github.com/AssemblyScript/assemblyscript
[as-pect-url]: <https://github.com/as-pect/as-pect>
[visitor-as-url]: <https://github.com/as-pect/visitor-as>

- Track the latest host functions of pallet-contracts

- New storage design, compatible with ink! v4

- Simple contract test framework

- More detailed documentation

- More interesting and complex examples

- ...
